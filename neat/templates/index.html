{% extends 'base.html' %}

{% block title %}
  neat
{% endblock %}

{% block header %}
  <h1>想你所想</h1>
{% endblock %}

{% block content %}
  <a href="{{ url_for('portal.create_task') }}" >添加任务</a>

  {% from "_formhelpers.html" import render_field %}
  <form method="post" id="service_form" >
    {{ form.csrf_token }}
    {{ render_field(form.task) }}
    {{ render_field(form.server) }}
    {{ render_field(form.group) }}
    {{ render_field(form.type) }}
    <p>
      <input type="button" value="提交" id="submit">
      <input type="reset" value="重置">
    </p>
  </form>

  <p>
    <label for="command">命令</label>
    <input type="text" id='command' name="command">
  </p>
  <p>
    <input type="button" value="提交" id="submit_command">
  </p>

  <textarea id="result" cols=48 rows=8 readonly></textarea>

  <table>
    <thead>
      <tr>
        <th>id</th>
        <th>任务名</th>
        <th>备注</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
        <tr>
          <td>{{ task['id'] }}</td>
          <td>{{ task['name'] }}</td>
          <td>{{ task['notes'] }}</td>
          <td>
            <button type="button" >下载</button>
            <button type="button">删除</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}

{% block script %}
  <script>
    function addSubmit() {
      $.ajax({
        method: 'POST',
        url: {{ url_for('portal.submit_task')|tojson }},
        data: $('#service_form').serialize()
      }).done(addShow);
    }

    function addShow(data) {
      celery_task_id = data.celery_task_id
      autoPlay(celery_task_id)
    }

    function autoPlay(celery_task_id){
      time = setInterval(function(){
        $.ajax({
          url: {{ url_for('portal.monitor_task')|tojson }},
          data: {"celery_task_id": celery_task_id},
          type: "POST",
          success: function(obj){
            for (result of obj.results){
              $('#result').append("taskid: "+celery_task_id+" status: "+result.status+"\n");
              if (result.status=="SUCCESS"){
                $('#result').append("exit_code: "+result.exit_code+"\n")
                $('#result').append("stdout: "+result.stdout+"\n")
                $('#result').append("stderr: "+result.stderr+"\n")
                clearInterval(time), function(){
  　　            autoPlay();
  　　           }
              }else if(result.status=='FAILURE'){
                $('#result').append("traceback: "+result.traceback+"\n")
                clearInterval(time),function(){
  　　            autoPlay();
  　　           }　　
              }else{
                $('#result').append("result: "+result.result.progress+"\n")
              }
            }
            var textarea = document.getElementById('result');
            textarea.scrollTop = textarea.scrollHeight;
          }
        })
      },5000
      );
    }

    $("#submit").click(addSubmit)


  </script>
{% endblock %}